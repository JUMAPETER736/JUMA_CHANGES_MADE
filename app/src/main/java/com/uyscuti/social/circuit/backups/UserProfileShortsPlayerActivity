package com.uyscut.flashdesign.ui.shorts

//                        playVideoAtPosition(position)
//                        exoPlayer!!.stop()
//                        exoPlayer!!.seekTo(0)
//
//                        exoPlayer!!.trackSelectionParameters = exoPlayer!!.trackSelectionParameters
//                            .buildUpon()
//                            .setMaxVideoSizeSd()
//                            .build()
// Update the current position to the selected position
//                        currentPosition = position
//                        Log.d(TAG, "onPageSelected: currentPosition = $currentPosition")
//                        // Play the video at the updated position
//                        playVideoAtPosition(currentPosition)
//                        playVideoAtPosition(position)

////                        playVideoAtPosition(position)
//                            exoPlayer!!.stop()
//                            exoPlayer!!.seekTo(0)
//
//                            exoPlayer!!.trackSelectionParameters = exoPlayer!!.trackSelectionParameters
//                                .buildUpon()
//                                .setMaxVideoSizeSd()
//                                .build()
//// Update the current position to the selected position
//                            currentPosition = position
//
//                            // Play the video at the updated position
//                            playVideoAtPosition(currentPosition)
//                        playVideoAtPosition(position)

import android.net.Uri
import android.os.Build
import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import android.util.Log
import android.widget.SeekBar
import android.widget.Toast
import androidx.activity.viewModels
import androidx.annotation.OptIn
import androidx.lifecycle.Observer
import androidx.lifecycle.lifecycleScope
import androidx.media3.common.C
import androidx.media3.common.MediaItem
import androidx.media3.common.PlaybackException
import androidx.media3.common.Player
import androidx.media3.common.util.UnstableApi
import androidx.media3.datasource.DefaultDataSourceFactory
import androidx.media3.datasource.DefaultHttpDataSource
import androidx.media3.datasource.HttpDataSource
import androidx.media3.datasource.cache.CacheDataSource
import androidx.media3.datasource.cache.SimpleCache
import androidx.media3.exoplayer.ExoPlayer
import androidx.media3.exoplayer.source.DefaultMediaSourceFactory
import androidx.media3.exoplayer.source.MediaSource
import androidx.media3.exoplayer.source.ProgressiveMediaSource
import androidx.media3.ui.PlayerView
import androidx.viewpager2.widget.ViewPager2
import com.uyscut.core.common.data.room.entity.ShortsEntity
import com.uyscut.core.common.data.room.entity.UserShortsEntity
import com.uyscuti.social.circuit.FlashApplication
import com.uyscut.flashdesign.R
import com.uyscuti.social.circuit.adapter.OnClickListeners
import com.uyscuti.social.circuit.adapter.OnCommentsClickListener
import com.uyscuti.social.circuit.adapter.OnVideoPreparedListener
import com.uyscuti.social.circuit.adapter.ShortsAdapter
import com.uyscuti.social.circuit.adapter.UserProfileShortsAdapter
import com.uyscut.flashdesign.databinding.ActivityUserProfileShortsPlayerBinding
import com.uyscuti.social.circuit.model.UserProfileShortsOnClickEvent
import com.uyscuti.social.circuit.ui.fragments.user_profile_fragments.SharedViewModel
import com.uyscuti.social.circuit.ui.fragments.user_profile_fragments.UserShortsFragment
import com.uyscuti.social.circuit.utils.KotlinUtils
import com.uyscuti.social.circuit.utils.getSerializable
import com.uyscut.network.api.retrofit.instance.RetrofitInstance
import dagger.hilt.android.AndroidEntryPoint
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext
import org.greenrobot.eventbus.EventBus
import org.greenrobot.eventbus.Subscribe
import org.greenrobot.eventbus.ThreadMode
import javax.inject.Inject

private const val TAG = "UserProfileShortsPlayerActivity"
@AndroidEntryPoint
class UserProfileShortsPlayerActivity : AppCompatActivity(), OnCommentsClickListener,
    OnClickListeners {
    private lateinit var shortsAdapter: UserProfileShortsAdapter
    private lateinit var playerView: PlayerView
//    private lateinit var shortSeekBar: SeekBar
    private lateinit var httpDataSourceFactory: HttpDataSource.Factory
    private lateinit var defaultDataSourceFactory: DefaultDataSourceFactory
    private lateinit var cacheDataSourceFactory: CacheDataSource.Factory

    private val simpleCache: SimpleCache = FlashApplication.cache
//    private val playbackStateListener: Player.Listener = playbackStateListener()

    private var exoPlayer: ExoPlayer? = null
    private val exoPlayerItems = ArrayList<ExoPlayerItem>()
    private var videoShorts = ArrayList<UserShortsEntity>()
    private var shortsList = ArrayList<String>()
    var lastPosition = 0
    private var isUserSeeking = false

    companion object {
        const val SHORTS_LIST = "shorts_list"
        const val CLICKED_SHORT = "clicked_short"
    }

    private lateinit var binding: ActivityUserProfileShortsPlayerBinding

    @Inject
    lateinit var retrofitIns: RetrofitInstance

    private val sharedViewModel by viewModels<SharedViewModel>()

    private var userShortsList: List<UserShortsEntity> = emptyList()

    // Global variable for clickedShort
    private var clickedShort: UserShortsEntity? = null

    private var currentPosition: Int = -1

    @OptIn(UnstableApi::class) override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityUserProfileShortsPlayerBinding.inflate(layoutInflater)
        setContentView(binding.root)

        playerView = findViewById(R.id.playerView)


        userShortsList = intent.getSerializableExtra(SHORTS_LIST) as ArrayList<UserShortsEntity>
//        val storedShortsList = intent.getSerializableExtra(SHORTS_LIST) as UserShortsEntity
        clickedShort = intent.getSerializableExtra(CLICKED_SHORT) as UserShortsEntity
//        val clickedShortIndex = userShortsList.indexOf(clickedShort)
//        Log.d(TAG, "onCreate: Clicked short index : $clickedShortIndex")
//        val getSerializablee = getSerializable(CLICKED_SHORT, UserShortsEntity::class.java)
//        intent.getSerializableC
        Log.d(TAG, "onCreate: Clicked short: $clickedShort")


        httpDataSourceFactory = DefaultHttpDataSource.Factory()
            .setAllowCrossProtocolRedirects(true)

        defaultDataSourceFactory = DefaultDataSourceFactory(
            this, httpDataSourceFactory
        )


        cacheDataSourceFactory = CacheDataSource.Factory()
            .setCache(simpleCache)
            .setUpstreamDataSourceFactory(httpDataSourceFactory)
            .setFlags(CacheDataSource.FLAG_IGNORE_CACHE_ON_ERROR)
        val mediaSourceFactory: MediaSource.Factory =
            DefaultMediaSourceFactory(this)
                .setDataSourceFactory(cacheDataSourceFactory)
        exoPlayer = ExoPlayer.Builder(this)
            .setMediaSourceFactory(mediaSourceFactory)
            .build()

        shortsAdapter = UserProfileShortsAdapter(
            this@UserProfileShortsPlayerActivity,
            this@UserProfileShortsPlayerActivity,
        )

        // Now you can work with the list of UserShortsEntity instances
        Log.d(TAG, "onCreate: storedShortsList: $userShortsList")
        Log.d(TAG, "onCreate: storedShortsList size: ${userShortsList.size}")
        shortsAdapter.addData(userShortsList)

        for (userShort in userShortsList) {
            // Do something with each UserShortsEntity
            Log.d(TAG, "onCreate: userShort: $userShortsList")
            videoShorts.add(userShort)

        }

//        shortsAdapter.addData(userShortsList)

        lifecycleScope.launch {
            withContext(Dispatchers.Main) {
                binding.shortsViewPager.adapter = shortsAdapter
                binding.shortsViewPager.orientation = ViewPager2.ORIENTATION_VERTICAL
                playerView.player = exoPlayer

                playerView.setOnClickListener {
                    Log.d("Pause", "Player view pause clicked")
//                togglesPausePlay()
                }
                binding.shortsViewPager.registerOnPageChangeCallback(object :
                    ViewPager2.OnPageChangeCallback() {

                    @OptIn(UnstableApi::class)
                    override fun onPageSelected(position: Int) {
//                        playVideoAtPosition(position)
                        exoPlayer!!.stop()
                        exoPlayer!!.seekTo(0)

                        exoPlayer!!.trackSelectionParameters = exoPlayer!!.trackSelectionParameters
                            .buildUpon()
                            .setMaxVideoSizeSd()
                            .build()
// Update the current position to the selected position
                        currentPosition = position

                        // Play the video at the updated position
                        playVideoAtPosition(currentPosition)
//                        playVideoAtPosition(position)

//                        val url = videoShorts[position].images[0].url
//                        val videoUri = Uri.parse(url)
//                        val mediaItem = MediaItem.fromUri(videoUri)
//                        val mediaSource = ProgressiveMediaSource.Factory(cacheDataSourceFactory)
//                            .createMediaSource(mediaItem)
//                        exoPlayer!!.setMediaSource(mediaSource)
//                        exoPlayer!!.prepare()
//                        exoPlayer!!.playWhenReady = true
//                        exoPlayer!!.play()
//                        exoPlayer!!.repeatMode = Player.REPEAT_MODE_ONE
//
////                        exoPlayer!!.addListener(playbackStateListener)
//                        exoPlayer!!.addListener(object : Player.Listener {
//                            @Deprecated("Deprecated in Java")
//                            override fun onPlayerStateChanged(
//                                playWhenReady: Boolean,
//                                playbackState: Int
//                            ) {
//                                if (playbackState == Player.STATE_READY && exoPlayer!!.duration != C.TIME_UNSET) {
////                                    shortsSeekBar.max = exoPlayer.duration.toInt()
////                                    shortsAdapter.setSeekBarMax(exoPlayer!!.currentPosition.toInt())
//                                    binding.shortSeekBar.max = exoPlayer!!.duration.toInt()
//                                }
//                            }
//
//                            override fun onPlayerError(error: PlaybackException) {
//                                super.onPlayerError(error)
//                                error.printStackTrace()
//                                Toast.makeText(
//                                    this@UserProfileShortsPlayerActivity,
//                                    "Can't play this video",
//                                    Toast.LENGTH_SHORT
//                                ).show()
//
//                            }
//
//                            @Deprecated("Deprecated in Java")
//                            override fun onPositionDiscontinuity(reason: Int) {
//                                updateSeekBar()
//                            }
//                        })

                    }


                    override fun onPageScrolled(
                        position: Int,
                        positionOffset: Float,
                        positionOffsetPixels: Int
                    ) {
                        super.onPageScrolled(position, positionOffset, positionOffsetPixels)

                        // Check if the user is scrolling towards the end or the beginning
                        // Check if the user is scrolling towards the end or the beginning
                        if (positionOffset > 0.5) {
                            // User is scrolling towards the end, update the current position to the next video
                            currentPosition = position + 1
                        } else if (positionOffset < -0.5) {
                            // User is scrolling towards the beginning, update the current position to the previous video
                            currentPosition = position - 1
                        } else {
                            // User is in a stable position, update the current position to the current video
                            currentPosition = position
                        }

                        // Play the video at the updated position
                        playVideoAtPosition(currentPosition)
                    }
                })
            }

        }
    }

    @OptIn(UnstableApi::class) private fun playVideoAtPosition(position: Int) {
        exoPlayer!!.stop()
        exoPlayer!!.seekTo(0)

        // Set track selection parameters
        exoPlayer!!.trackSelectionParameters = exoPlayer!!.trackSelectionParameters
            .buildUpon()
            .setMaxVideoSizeSd()
            .build()

        // Calculate the relative position based on the distance from the clicked position
        val relativePosition = currentPosition - position

        // Adjust the playback based on the relative position
        val finalPosition = relativePosition.toLong() * C.TIME_UNSET

        // Get the video URL for the selected position
        val url = userShortsList[position].images[0].url
        val videoUri = Uri.parse(url)
        val mediaItem = MediaItem.fromUri(videoUri)

        // Create media source
        val mediaSource = ProgressiveMediaSource.Factory(cacheDataSourceFactory)
            .createMediaSource(mediaItem)

        // Set the initial position for the ExoPlayer
        exoPlayer!!.setMediaSource(mediaSource, finalPosition)
        exoPlayer!!.prepare()
        exoPlayer!!.playWhenReady = true
        exoPlayer!!.play()
        exoPlayer!!.repeatMode = Player.REPEAT_MODE_ONE
    }

//    @OptIn(UnstableApi::class) private fun playVideoAtPosition(position: Int) {
//        val clickedShortIndex = userShortsList.indexOf(clickedShort)
//
//        // Calculate the distance between the clicked index and the current position
//        val distance = clickedShortIndex - position
//
//        // Calculate the relative position based on the distance
//        val relativePosition = if (distance < 0) {
//            // If the current position is 0, and clickedShortIndex is greater, play clickedShortIndex
//            clickedShortIndex
//        } else {
//            // Otherwise, play the current position
//            position
//        }
//
//        // Adjust the playback based on the relative position
//        val finalPosition = relativePosition.toLong() * C.TIME_UNSET
//
//        // Get the video URL for the selected position
//        val url = userShortsList[relativePosition].images[0].url
//        val videoUri = Uri.parse(url)
//        val mediaItem = MediaItem.fromUri(videoUri)
//
//        // Create media source
//        val mediaSource = ProgressiveMediaSource.Factory(cacheDataSourceFactory)
//            .createMediaSource(mediaItem)
//
//        // Set the initial position for the ExoPlayer
//        exoPlayer!!.setMediaSource(mediaSource, finalPosition)
//        exoPlayer!!.prepare()
//        exoPlayer!!.playWhenReady = true
//        exoPlayer!!.play()
//        exoPlayer!!.repeatMode = Player.REPEAT_MODE_ONE
//
//    }


    @Subscribe(threadMode = ThreadMode.MAIN)
    fun onMessageEvent(event: UserProfileShortsOnClickEvent) {
        // Handle the event here
        Log.d(TAG, "onMessageEvent: user short entity: ${event.shortsEntity}")
        Log.d(TAG, "onMessageEvent: user short entity: ${event.shortsEntity?.size}")
    }

    override fun onCommentsClick(position: Int) {

    }

    override fun onSeekBarChanged(progress: Int) {

    }

    override fun onDownloadClick(url: String, fileLocation: String) {

    }

    override fun onStart() {
        super.onStart()
//        EventBus.getDefault().register(this)
    }
    override fun onDestroy() {
        super.onDestroy()
//        EventBus.getDefault().unregister(this)
    }

    private fun updateSeekBar() {
        exoPlayer?.let { player ->
            if (!isUserSeeking) {
                val currentPosition = player.currentPosition.toInt()
                binding.shortSeekBar.progress = currentPosition
            }
        }
    }
}
