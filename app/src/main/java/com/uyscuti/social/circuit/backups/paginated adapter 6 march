package com.uyscut.flashdesign.adapter.notifications;

import android.annotation.SuppressLint;
import android.app.Activity;
import android.view.ViewGroup;

import androidx.annotation.NonNull;
import androidx.recyclerview.widget.GridLayoutManager;
import androidx.recyclerview.widget.LinearLayoutManager;
import androidx.recyclerview.widget.RecyclerView;

import java.util.ArrayList;
import java.util.Collection;
import java.util.List;

public abstract class AdPaginatedAdapter<ITEM, VH extends RecyclerView.ViewHolder> extends RecyclerView.Adapter<VH> {
    private List<ITEM> mDataSet = new ArrayList<>();
    private OnPaginationListener mListener;
    private int mStartPage = 1;
    private int mCurrentPage = 1;
    private int mPageSize = 10;
    private RecyclerView mRecyclerView;
    private boolean loadingNewItems = true;

    public com.uyscut.flashdesign.adapter.PaginatedAdapter.LoadMoreListener loadMoreListener;

    public void setLoadMoreListener(com.uyscut.flashdesign.adapter.PaginatedAdapter.LoadMoreListener loadMoreListener) {
        this.loadMoreListener = loadMoreListener;
    }

    public void loadMoreIfNeeded(int position) {
        if (position == getItemCount() - 1 && loadMoreListener != null) {
            int nextPageNumber = getItemCount() / 10 + 1;
            loadMoreListener.onLoadMore(nextPageNumber);
        }
    }

    @NonNull
    public abstract VH onCreateViewHolder(@NonNull ViewGroup parent, int viewType);

    public abstract void onBindViewHolder(@NonNull VH holder, int position);

    public int getItemCount() {
        return mDataSet.size();
    }

    @SuppressLint("NotifyDataSetChanged")
    public void submitItems(Collection<? extends ITEM> collection) {
        int previousSize = mDataSet.size();
        mDataSet.addAll(collection);
        notifyItemRangeInserted(previousSize, collection.size());
        if (mListener != null) {
            mListener.onCurrentPage(mCurrentPage);
            if (collection.size() == mPageSize) {
                loadingNewItems = false;
            } else {
                mListener.onFinish();
            }
        }
    }

    @SuppressLint("NotifyDataSetChanged")
    public void submitItem(ITEM item) {
        mDataSet.add(item);
        notifyDataSetChanged();
    }

    @SuppressLint("NotifyDataSetChanged")
    public void submitItem(ITEM item, int position) {
        mDataSet.add(position, item);
        notifyDataSetChanged();
    }

    @SuppressLint("NotifyDataSetChanged")
    public void clear() {
        mDataSet.clear();
        notifyDataSetChanged();
        notifyEmptyDatasetChanged();
    }

    protected ITEM getItem(int position) {
        return mDataSet.get(position);
    }

    public void setStartPage(int mFirstPage) {
        this.mStartPage = mFirstPage;
        this.mCurrentPage = mFirstPage;
    }

    public boolean emptyDataSet() {
        return mDataSet.isEmpty();
    }

    public int getStartPage() {
        return mStartPage;
    }

    public int getCurrentPage() {
        return mCurrentPage;
    }

    public RecyclerView getRecyclerView() {
        return mRecyclerView;
    }

    public void setRecyclerView(RecyclerView recyclerView) {
        this.mRecyclerView = recyclerView;
        initPaginating();
        setAdapter();
    }

    public void setDefaultRecyclerView(Activity activity, int recyclerViewId) {
        RecyclerView recyclerView = activity.findViewById(recyclerViewId);
        recyclerView.setLayoutManager(new LinearLayoutManager(activity));
        recyclerView.setHasFixedSize(true);
        this.mRecyclerView = recyclerView;
        initPaginating();
        setAdapter();
    }

    private void setAdapter() {
        mRecyclerView.setAdapter(this);
    }

    public void setPageSize(int pageSize) {
        this.mPageSize = pageSize;
    }

    private void initPaginating() {
        mRecyclerView.addOnScrollListener(new RecyclerView.OnScrollListener() {
            @Override
            public void onScrollStateChanged(RecyclerView recyclerView, int newState) {
                super.onScrollStateChanged(recyclerView, newState);
            }

            @Override
            public void onScrolled(RecyclerView recyclerView, int dx, int dy) {
                super.onScrolled(recyclerView, dx, dy);
                LinearLayoutManager layoutManager = LinearLayoutManager.class.cast(recyclerView.getLayoutManager());
                int totalItemCount = layoutManager.getItemCount();
                int lastVisible = layoutManager.findLastVisibleItemPosition();
                boolean endHasBeenReached = lastVisible + 2 >= totalItemCount;
                if (totalItemCount > 0 && endHasBeenReached) {
                    if (mListener != null) {
                        if (!loadingNewItems) {
                            loadingNewItems = true;
                            mListener.onNextPage(++mCurrentPage);
                        }
                    }
                }
            }
        });
    }

    public void setOnPaginationListener(OnPaginationListener onPaginationListener) {
        this.mListener = onPaginationListener;
    }

    public void updateItem(int position, ITEM updatedItem) {
        if (position >= 0 && position < mDataSet.size()) {
            mDataSet.set(position, updatedItem);
            notifyItemChanged(position);
        }
    }

    public interface OnPaginationListener {
        void onCurrentPage(int page);

        void onNextPage(int page);

        void onFinish();
    }

    public interface LoadMoreListener {
        void onLoadMore(int pageNumber);
    }

    // Interface to notify implementing class when dataset is empty
    public interface OnEmptyDataSetListener {
        void onEmptyDataSet();
    }

    // Member variable to hold the listener instance
    private OnEmptyDataSetListener mEmptyDataSetListener;

    // Setter method for the listener
    public void setOnEmptyDataSetListener(OnEmptyDataSetListener listener) {
        mEmptyDataSetListener = listener;
    }

    // Method to notify the implementing class when dataset is empty
    private void notifyEmptyDatasetChanged() {
        if (emptyDataSet() && mEmptyDataSetListener != null) {
            mEmptyDataSetListener.onEmptyDataSet();
        }
    }
}