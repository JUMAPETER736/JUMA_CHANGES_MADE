package com.uyscut.flashdesign.adapter

import android.content.Context
import android.graphics.Bitmap
import android.media.MediaMetadataRetriever
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.ImageView
import android.widget.TextView
import androidx.recyclerview.widget.RecyclerView
import com.bumptech.glide.Glide
import com.bumptech.glide.load.engine.DiskCacheStrategy
import com.bumptech.glide.load.resource.bitmap.CircleCrop
import com.bumptech.glide.request.RequestOptions
import com.uyscut.core.common.data.room.entity.ShortsEntity
import com.uyscut.flashdesign.R
import androidx.recyclerview.widget.GridLayoutManager


class ShortsUserProfileAdapter(context: Context?) :
    RecyclerView.Adapter<ShortsUserProfileAdapter.ViewHolder?>() {
    private val dataList: MutableList<String>
    private val inflater: LayoutInflater
    private val shortsList: MutableList<ShortsEntity> = mutableListOf()

    // Add a reference to your GridLayoutManager
    private lateinit var layoutManager: GridLayoutManager

    // Set the layout manager in your activity or fragment
    fun setLayoutManager(layoutManager: GridLayoutManager) {
        this.layoutManager = layoutManager
    }


    init {
        inflater = LayoutInflater.from(context)
        dataList = ArrayList()
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): ViewHolder {
        val view: View = inflater.inflate(R.layout.shorts_user_profile_item, parent, false)
        return ViewHolder(view)
    }

    override fun onBindViewHolder(holder: ViewHolder, position: Int) {
        val data = shortsList[position]
        holder.bind(data)
    }

    override fun getItemCount(): Int {
        return shortsList.size
    }

//    fun addItem(item: List<ShortsEntity>) {
//        shortsList.add(item)
//        notifyItemInserted(shortsList.size - 1)
//    }

    fun addData(newData: List<ShortsEntity>) {
        // Determine the position where the new data will be inserted
        shortsList.addAll(newData)
        notifyItemInserted(shortsList.size - 1)

//        val startPosition = shortsList.size
//
//        // Add the new data to the existing list
//
//        // Notify the adapter that new items have been inserted
//        if (startPosition == 0) {
//            // If the adapter was empty, use notifyDataSetChanged
//            notifyDataSetChanged()
//        } else {
//            // Otherwise, use notifyItemRangeInserted
////            notifyItemRangeInserted(startPosition, newData.size)
//            // OR use notifyItemInserted for a single item
//            // notifyItemInserted(startPosition)
//        }
    }


    inner class ViewHolder(itemView: View) : RecyclerView.ViewHolder(itemView) {
        private val thumbnailImageView: ImageView

        init {
            thumbnailImageView =
                itemView.findViewById(R.id.thumbnailImageView) // Replace with the actual ID of the TextView in your item layout
        }

        fun bind(data: ShortsEntity?) {
            Log.d("thumbnailImageView", "bind: in bind data $data")
//            thumbnailImageView.text = data
//            thumbnailImageView
            // Load video thumbnail using Glide
            loadVideoThumbnail(thumbnailImageView.context, data!!.images[0].url, thumbnailImageView)
        }

        private fun loadVideoThumbnail(context: Context, videoUrl: String, imageView: ImageView) {
            // Create a MediaMetadataRetriever
            val retriever = MediaMetadataRetriever()

            try {
                // Set the data source to the video URL
                retriever.setDataSource(videoUrl)

                // Retrieve the first frame (thumbnail) of the video
                val bitmap: Bitmap? = retriever.frameAtTime

                // Use Glide to load and display the thumbnail
                Glide.with(context)
                    .load(bitmap)
                    .apply(RequestOptions.centerCropTransform())
                    .placeholder(R.drawable.flash21)
                    .diskCacheStrategy(
                        DiskCacheStrategy.ALL
                    )
                    .into(imageView)
            } catch (e: Exception) {
                e.printStackTrace()
            } finally {
                // Release the MediaMetadataRetriever
                retriever.release()
            }
        }
    }
}


abstract class PaginationListener(private val layoutManager: GridLayoutManager) :
    RecyclerView.OnScrollListener() {

    private val visibleThreshold = 5  // Adjust this threshold as needed
    private var loading = true
    private var currentPage = 1

    abstract fun loadMoreItems(currentPage: Int)

    override fun onScrolled(recyclerView: RecyclerView, dx: Int, dy: Int) {
        super.onScrolled(recyclerView, dx, dy)

        val totalItemCount = layoutManager.itemCount
        val lastVisibleItem = layoutManager.findLastVisibleItemPosition()

        if (!loading && totalItemCount <= (lastVisibleItem + visibleThreshold)) {
            loading = true
            currentPage++
            loadMoreItems(currentPage)
        }
    }

    fun setLoading(loading: Boolean) {
        this.loading = loading
    }
}



