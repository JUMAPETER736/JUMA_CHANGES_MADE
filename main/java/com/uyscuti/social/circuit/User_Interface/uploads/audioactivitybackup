class AudioActivity : AppCompatActivity() {
    private lateinit var binding: ActivityAudioBinding
    private val REQUEST_PERMISSION = 158

    private lateinit var audioAdapter: AudioAdapter
    private val selectedAudios: MutableList<String> = mutableListOf()
    private val selectedUris: MutableList<String> = mutableListOf()
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityAudioBinding.inflate(layoutInflater)
        setContentView(binding.root)

        binding.toolbar.setNavigationIcon(R.drawable.baseline_arrow_back_ios_24_black)

        binding.toolbar.setNavigationOnClickListener {
            onBackPressed()
        }


        if (ContextCompat.checkSelfPermission(
                this,
                Manifest.permission.READ_EXTERNAL_STORAGE
            ) != PackageManager.PERMISSION_GRANTED
        ) {
            ActivityCompat.requestPermissions(
                this,
                arrayOf(Manifest.permission.READ_EXTERNAL_STORAGE),
                REQUEST_PERMISSION
            )
        } else {
            loadAndDisplayAudio()
        }
    }

    override fun onRequestPermissionsResult(
        requestCode: Int,
        permissions: Array<out String>,
        grantResults: IntArray
    ) {
        super.onRequestPermissionsResult(requestCode, permissions, grantResults)
        if (requestCode == REQUEST_PERMISSION && grantResults.isNotEmpty() && grantResults[0] == PackageManager.PERMISSION_GRANTED) {
            loadAndDisplayAudio()
        }
    }


    private fun loadAndDisplayAudio() {
        val projection = arrayOf(MediaStore.Audio.Media._ID, MediaStore.Audio.Media.DATA)
        val cursor = contentResolver.query(
            MediaStore.Audio.Media.EXTERNAL_CONTENT_URI,
            projection,
            null,
            null,
            null
        )

        cursor?.use {
            if (it.moveToFirst()) {
                val audioList = mutableListOf<String>()
                val uriList = mutableListOf<Uri>()
                val dataIndex = it.getColumnIndex(MediaStore.Audio.Media.DATA)

                do {
                    val audioPath = it.getString(dataIndex)
                    if (!audioPath.isNullOrBlank()) {
                        audioList.add(audioPath)
                        val uri = ContentUris.withAppendedId(MediaStore.Video.Media.EXTERNAL_CONTENT_URI, it.getLong(0))
                        uriList.add(uri)
                    }
                } while (it.moveToNext())

                val recyclerView: RecyclerView = findViewById(R.id.recyclerView)
                val layoutManager = LinearLayoutManager(this)
                recyclerView.layoutManager = layoutManager
                val adapter = AudioAdapter(audioList, resources) { audioUrl ->
                    // Pass the image URL back to the UserActivity
                    val selectedAudioIndex = audioList.indexOf(audioUrl)
                    val selectedAudioUri = uriList[selectedAudioIndex]
                    val resultIntent = Intent()
                    resultIntent.putExtra("audio_url", audioUrl)
                    resultIntent.putExtra("aUri", selectedAudioUri.toString())
                    setResult(Activity.RESULT_OK, resultIntent)
                    finish()
                }
                recyclerView.adapter = adapter
            } else {
                // Handle the case where there are no audio files
                Toast.makeText(this, "No audio files found", Toast.LENGTH_SHORT).show()
            }
        }
    }
}
